<!DOCTYPE html>
<html lang="ko">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ì¼ìš”ì¼ì— ë­ ë¨¹ì§€?</title>


  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- JS -->
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js"
    integrity="sha384-9/reFTGAW83EW2RDu2S0VKaIzap3H66lZH81PoYlFhbGU+6BZp6G7niu735Sk7lN"
    crossorigin="anonymous"></script>

  <script>

    document.addEventListener("DOMContentLoaded", () => {
      const modal = document.getElementById("modal");
      const openModalBtn = document.getElementById("open-modal");
      const closeModalBtn = document.getElementById("close-modal");

      // ëª¨ë‹¬ ì—´ê¸°
      openModalBtn.addEventListener("click", () => {
        modal.classList.remove("hidden");
      });

      // ëª¨ë‹¬ ë‹«ê¸° (ì·¨ì†Œ ë²„íŠ¼)
      closeModalBtn.addEventListener("click", () => {
        modal.classList.add("hidden");
      });

      // ëª¨ë‹¬ ë°”ê¹¥ ì˜ì—­ í´ë¦­ ì‹œ ë‹«ê¸°
      modal.addEventListener("click", (event) => {
        if (event.target === modal) {
          modal.classList.add("hidden");
        }
      });
    });


    function showMenuCard(id, name) {
      // $(`#card-${id}`).empty();
      let card = document.getElementById(`card-${id}`);

      card.innerHTML = `
      <div id="card-menu" class="w-96 h-48 flex flex-col border-1 border-gray-200 shadow-lg rounded-lg overflow-hidden">
        <div class="h-40 flex flex-col justify-center space-y-2 items-center">
          <div class="flex flex-col">
            <div>
              <div class="mt-2">
                <div class="flex items-center rounded-md bg-white pl-3 outline-1 -outline-offset-1 outline-gray-300 has-[input:focus-within]:outline-2 has-[input:focus-within]:-outline-offset-2 has-[input:focus-within]:outline-indigo-600">
                  <input type="text" name="menu_name" id="menu_name"
                    class="border block min-w-0 grow py-1.5 pr-3 pl-1 text-base text-gray-900 placeholder:text-gray-400 focus:outline-none sm:text-sm/6"
                    placeholder="ë©”ë‰´ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”">
                </div>
              </div>
            </div>
            <div class="text-xs text-red-500">ì¶”ì²œ ë©”ë‰´ ì´ë¦„ì„ ì…ë ¥í•´ ì£¼ì„¸ìš”</div>
          </div>
        </div>

          <!-- ìˆ˜ì •ëœ ë¶€ë¶„: restaurant_nameê³¼ menu_nameì„ í•¨ê»˜ ì „ì†¡ -->
        <form method="POST" action="{{ url_for('add_menu') }}" id="menuForm">
          <input type="hidden" name="restaurant_name" value="${name}">
          <input type="hidden" name="menu_name" id="hidden-menu-name">

          <div class="flex space-x-8 mt-auto mb-3 justify-center text-sm text-white">
            <button type="submit" class="border rounded-lg border-blue-500 bg-blue-500 p-2" onclick="submitForm(event)">í™•ì¸</button>
            <div class="border rounded-lg border-red-500 bg-red-500 p-2" onclick="reloadPage()">ì·¨ì†Œ</div>
          </div>
        </form>
      </div>`;

      $(`#card-${id}`).append(temp_html);

    }
    function submitForm(event) {
      const menuName = document.getElementById("menu_name").value; // ì‚¬ìš©ìê°€ ì…ë ¥í•œ ë©”ë‰´ ì´ë¦„ ê°€ì ¸ì˜¤ê¸°
      if (!menuName) {
        alert("ë©”ë‰´ ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
        event.preventDefault(); // í¼ ì œì¶œì„ ë§‰ìŒ
        return;
      }
      document.getElementById("hidden-menu-name").value = menuName; // hidden í•„ë“œì— ì„¤ì •
      document.getElementById("menuForm").submit(); // í¼ ì œì¶œ
    }
    function reloadPage() {
      location.reload();
    }

    // ì¹´í…Œê³ ë¦¬ ëª©ë¡ í† ê¸€
    function toggleCategoryList() {
      const categoryList = document.getElementById("category-list");
      categoryList.classList.toggle("hidden");
    }

    // ì¹´í…Œê³ ë¦¬ ì„ íƒ
    function selectCategory(category) {
      // ì¹´í…Œê³ ë¦¬ë¥¼ ë²„íŠ¼ì— í‘œì‹œ
      document.getElementById('menu-button').innerText = category;

      // ì„ íƒëœ ì¹´í…Œê³ ë¦¬ë¥¼ hidden í•„ë“œì— ì„¤ì •
      document.getElementById('selected-category').value = category;

      // ì¹´í…Œê³ ë¦¬ ëª©ë¡ ìˆ¨ê¸°ê¸°
      toggleCategoryList();
    }

    function openDirections(mapUrl) {
      window.open(mapUrl, '_blank');  // '_blank'ë¡œ ìƒˆ ì°½ì—ì„œ ì—´ê¸°
    }

    window.addEventListener('DOMContentLoaded', function () {
      // selectedCategoryì˜ ê°’ ê°€ì ¸ì˜¤ê¸°
      const selectedCategory = document.getElementById('selectedCategory').textContent.trim();

      // ë¡œë”© ë©”ì‹œì§€ ìš”ì†Œ ê°€ì ¸ì˜¤ê¸°
      const loadingElement = document.getElementById('loading');

      // selected_categoryê°€ "ì „ì²´"ì¼ ê²½ìš° ë¡œë”© ë©”ì‹œì§€ í‘œì‹œ
      if (selectedCategory === "ì „ì²´") {
        loadingElement.classList.remove('hidden');
      } else {
        loadingElement.classList.add('hidden');
      }
    });

    let page = 1;
    let offset = 6;
    let limit = 6;
    let loading = false;


    window.addEventListener('DOMContentLoaded', function () {
      const loadingElement = document.getElementById('loading');

      const observer = new IntersectionObserver((entries, observer) => {
        entries.forEach(entry => {
          if (entry.isIntersecting && !loading) {
            loading = true; // ë¡œë”© ìƒíƒœ ë³€ê²½

            // ë¡œë”© ì¤‘ ë©”ì‹œì§€ ì²˜ë¦¬
            //console.log('ë¡œë”© ì¤‘... ìš”ì†Œê°€ í™”ë©´ì— ë‚˜íƒ€ë‚¬ìŠµë‹ˆë‹¤.');
            console.log(offset)
            console.log(limit)

            // ì„œë²„ì—ì„œ ë°ì´í„° ë¡œë“œ
            fetch(`/list/infinite?offset=${offset}&limit=${limit}`)
              .then(response => {
                if (!response.ok) {
                  throw new Error(`ì„œë²„ ì˜¤ë¥˜: ${response.status}`);
                }
                return response.json();
              })
              .then(data => {
                if (data.error) {
                  console.error("ì—ëŸ¬:", data.error);
                  return;
                }

                if (data.restaurants && data.restaurants.length > 0) {
                  data.restaurants.forEach(restaurant => {


                    // ë©”ë‰´ í•­ëª©ë“¤ ìƒì„±
                    let menuHtml = '';
                    if (restaurant.menus && restaurant.menus.length > 0) {
                      restaurant.menus.forEach(menu => {
                        menuHtml += `<div class="border border-gray-500 rounded-full p-1 text-xs">${menu}</div>`; // ë©”ë‰´ì— ë§ëŠ” ë‚´ìš© ì¶”ê°€
                      });
                    } else {
                      menuHtml = '';
                    }
                    let temp_html = `
                    <div id="card-${restaurant.naver_url}" class="w-96 h-48 flex border border-gray-200 rounded-lg overflow-hidden shadow-lg">
                      <div class="bg-gray-200 w-1/3">
                        <img src="${restaurant.image_url}" alt="ì‹ë‹¹ ì´ë¯¸ì§€" class="w-full h-full object-cover" />
                      </div>
                      <div class="w-2/3 ml-4 flex flex-col">
                        <div class="h-40 space-y-2">
                          <h3 class="text-lg font-bold">${restaurant.name}</h3>
                          <p class="text-sm">${restaurant.address}</p>
                          <p class="text-gray-500 text-sm"># ${restaurant.category}</p>

                           <div class="flex space-x-2">
                             ${menuHtml}
                            </div>

                        </div>
                        <div class="flex flex-row space-x-4 mt-auto justify-center text-sm text-white mb-2 w-full">
                          <form method="POST"  action="/like/${restaurant.restaurant_id}" class="flex w-full space-x-2">
                            <button type="submit" class="border rounded-lg border-[#0C1D1D] bg-[#0C1D1D] flex-1 text-center">
                              â¤ï¸  <span>${restaurant.likes}</span>
                            </button>
                            <button class="border rounded-lg border-[#0C1D1D] bg-[#0C1D1D] flex-1 text-center"
                              onclick="openDirections('${restaurant.map_url}')">
                              ğŸ“ ê¸¸ì°¾ê¸°
                            </button>
                            <button type="button" class="border rounded-lg border-[#0C1D1D] bg-[#0C1D1D] flex-1 text-center"
                            onclick="showMenuCard('${restaurant.naver_url}', '${restaurant.name}')">
                              ğŸ—’ ë©”ë‰´ì¶”ì²œ
                            </button>
                          </form>
                        </div>
                      </div>
                    </div>`;

                    // ìƒˆë¡œìš´ ì¹´ë“œ ì¶”ê°€
                    $('#card-list').append(temp_html);
                  });

                  offset += limit; // ë‹¤ìŒ ë°ì´í„° ë¡œë“œ
                }
                loading = false; // ë¡œë”© ì™„ë£Œ
              })
              .catch(error => {
                console.error('ë°ì´í„° ìš”ì²­ ì˜¤ë¥˜:', error);
                loading = false; // ì˜¤ë¥˜ ì‹œ ë¡œë”© ì™„ë£Œ ì²˜ë¦¬
              });
          }
        });
      }, { threshold: 1.0 });

      // ë¡œë”© ì¤‘ ìš”ì†Œë¥¼ ê´€ì°°í•˜ë„ë¡ ì„¤ì •
      if (loadingElement) {
        observer.observe(loadingElement);
      }
    });

    function showLoading() {
    document.getElementById("loading-spinner").classList.remove("hidden");

    document.getElementById("naver-link").style.minHeight = "280px";

    document.getElementById("confirm").disabled = true;
    document.getElementById("confirm").innerText = "ë“±ë¡ ì¤‘...";

    return true;
  }
  </script>
</head>

<body>
  <!-- í—¤ë” -->
  <div class="bg-black text-white flex flex-col">
    <header class="w-full flex justify-between items-center px-6 py-4">
      <!-- ì œëª©: ì¤‘ì•™ ì •ë ¬ -->
      <h1 class="text-white text-3xl font-semibold text-center flex-1">ì¼ìš”ì¼ì— ë­ ë¨¹ì§€?</h1>

      <!-- ë¡œê·¸ì•„ì›ƒ ë²„íŠ¼: ì˜¤ë¥¸ìª½ ìƒë‹¨ ì •ë ¬ -->
      <a href="{{ url_for('logout') }}" class="text-green-400 hover:text-green-300 text-sm">
        LOGOUT
      </a>
    </header>
    <main class="mt-10 flex flex-col">
      <div class="flex flex-col justify-start ml-8">
        <p class="text-green-400 text-lg">Your Journey starts Here_</p>
        <p class="text-green-400 text-lg">But, Our Cafeteria is Closed on Sundays_</p>

      </div>
      <div class="flex justify-end mr-8 mb-6">
        <p class="text-green-400 mt-6 text-lg">
          ì¼ìš”ì¼, ë°°ê°€ ê³ í”Œ ë™ë£Œ ì •ê¸€ëŸ¬ë“¤ì„ ìœ„í•´,<br>
          ìš°ì¸¡ í•˜ë‹¨ ë²„íŠ¼ì„ ëˆŒëŸ¬,<br>
          ìº í¼ìŠ¤ ê·¼ì²˜ ë§›ì§‘ì„ ë“±ë¡í•´ ì£¼ì„¸ìš” :)
        </p>
      </div>

    </main>
  </div>
  <!-- ë§í¬ ì…ë ¥ í”Œë¡œíŒ… ë²„íŠ¼ -->
  <div id="open-modal" class="relative">
    <button
      class="fixed bottom-8 right-8 bg-blue-500 text-white p-4 rounded-full shadow-lg hover:bg-blue-600 transition-colors">
      <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"
        class="size-6">
        <path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15" />
      </svg>
    </button>
  </div>
  <div class="hidden" id="selectedCategory">{{selected_category}}</div>
  <!-- ì¹´í…Œê³ ë¦¬ í•„í„° -->
  <nav class="w-full bg-gray-800 py-3">
    <ul class="flex justify-center ml-6 space-x-6 text-sm text-white font-medium">
      <li class="mr-8"><code>&lt;Category /&gt;</code></li>
      {% for category in categories %}
      <li class=" cursor-pointer hover:text-gray-100 {% if category==selected_category %} text-white font-bold {%
      else %} text-gray-200 {% endif %}">
        <a href="{{ url_for('main', category=category) }}" class="category-link">{{ category | capitalize }}</a>
      </li>
      {% endfor %}
    </ul>
  </nav>

  <div class="mx-auto max-w-4xl p-4">
    <h2 class="text-xl font-semibold mb-4"><code>&lt;List /&gt;</code></h2>

    <div id="card-list" class="flex flex-wrap gap-8 p-4">
      {% if restaurants %} {% for restaurant in restaurants %}
      <div id="card-{{ loop.index }}"
        class="w-96 h-48 flex border border-gray-200 rounded-lg overflow-hidden shadow-lg">
        <div class="bg-gray-200 w-1/3">
          <img src="{{ restaurant.image_url }}" alt="ì‹ë‹¹ ì´ë¯¸ì§€" class="w-full h-full object-cover" />
        </div>
        <div class="w-2/3 ml-4 flex flex-col">
          <div class="h-40 space-y-2">
            <h3 class="text-lg font-bold">{{ restaurant.name }}</h3>
            <p class="text-sm">{{ restaurant.address }}</p>
            <p class="text-gray-500 text-sm"># {{ restaurant.description }}</p>
            <div class="flex space-x-2 text-xs text-gray-500">
              <div class="flex space-x-2">
                {% if restaurant.menus %}
                {% for menu in restaurant.menus %}
                <div class="border border-gray-500 rounded-full p-1 text-xs">
                  {{menu}}
                </div>
                {% endfor %}
                {% endif %}
              </div>
            </div>
          </div>
          <div class="flex flex-row space-x-4 mt-auto justify-center text-sm text-white mb-2 w-full">
          <form method="POST" action="{{ url_for('like_restaurant', restaurant_id=restaurant.restaurant_id) }}" class="flex w-full space-x-2">
            <button type="submit" class="border rounded-lg border-[#0C1D1D] bg-[#0C1D1D] flex-1 text-center">
              â¤ï¸ <span>{{ restaurant.likes }}</span>
            </button>
            <button type="button" class="border rounded-lg border-[#0C1D1D] bg-[#0C1D1D] flex-1 text-center"
              onclick="openDirections('{{ restaurant.map_url }}')">
              ğŸ“ ê¸¸ì°¾ê¸°
            </button>
            <button type="button" class="border rounded-lg border-[#0C1D1D] bg-[#0C1D1D] flex-1 text-center"
              onclick="showMenuCard('{{ loop.index }}', '{{ restaurant.name }}')">
              ğŸ—’ ë©”ë‰´ì¶”ì²œ
            </button>
          </form>
        </div>
        </div>
      </div>
      {% endfor %}
      {% else %}
      <p class="text-center text-gray-500">
        í•´ë‹¹ ì¹´í…Œê³ ë¦¬ì— ë“±ë¡ëœ ì‹ë‹¹ì´ ì—†ìŠµë‹ˆë‹¤.
      </p>
      {% endif %}

    </div>
    <div id="loading" class="text-center w-full py-4 text-gray-500">
      ë¡œë”© ì¤‘...
    </div>
  </div>


  <!-- í”Œë¡œíŒ… ë²„íŠ¼ í´ë¦­ ì‹œ ë‚˜íƒ€ë‚˜ëŠ” ëª¨ë‹¬ -->
  <div id="modal" class="fixed inset-0 bg-black/30 flex justify-center items-center hidden">
    <div id="naver-link" class="w-96 h-60 flex flex-col border border-gray-200 shadow-lg rounded-lg bg-white p-4">
      <div class="h-40 flex flex-col justify-center space-y-2 items-center">
        <div class="relative inline-block text-left">
          <button type="button"
            class="inline-flex w-48 justify-center gap-x-1.5 rounded-md bg-white px-3 py-2 text-sm font-semibold text-gray-900 ring-1 shadow-xs ring-gray-300 ring-inset hover:bg-gray-50"
            id="menu-button" onclick="toggleCategoryList()">
            ì¹´í…Œê³ ë¦¬ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”
          </button>
          <!-- ì¹´í…Œê³ ë¦¬ ëª©ë¡ (ìˆ¨ê²¨ì ¸ ìˆìŒ) -->
          <div id="category-list"
            class="absolute w-full mt-2 bg-white shadow-lg rounded-md max-h-40 overflow-y-auto hidden">
            <ul class="py-1 text-sm text-gray-700">
              {% for category_item in categories[1:] %}
              <li>
                <button
                  class="block w-full text-left px-4 py-2 
                      {% if category_item == selected_category %} text-black font-bold {% else %} text-gray-500 {% endif %}"
                  onclick="selectCategory('{{ category_item }}')">
                  {{ category_item }}
                </button>
              </li>
              {% endfor %}
            </ul>
          </div>
        </div>
      </div>
      <!--  ë¡œë”© ì¤‘ í‘œì‹œë  Spinner -->
      <div id="loading-spinner" class="hidden flex justify-center items-center mt-4 mb-4">
        <div class="animate-spin rounded-full h-8 w-8 border-t-2 border-b-2 border-blue-500"></div>
        <p class="ml-2 text-sm text-blue-500">ë“±ë¡ ì¤‘...</p>
      </div>
      <form method="POST" action="{{ url_for('get_naver_url') }}" onsubmit="showLoading()">
        <input type="hidden" name="category" id="selected-category"> <!-- ì¹´í…Œê³ ë¦¬ hidden í•„ë“œ -->

        <div class="flex flex-col">
          <input type="text" name="naver_url" id="price"
            class="block w-full py-1.5 px-3 text-base text-gray-900 placeholder:text-gray-400 focus:outline-none border border-gray-300 rounded-md"
            placeholder="ë„¤ì´ë²„ ì§€ë„ ë§í¬ ì…ë ¥" />
          <div class="text-xs text-red-500 mt-2 mb-2">
            ë„¤ì´ë²„ì§€ë„ > ê³µìœ  íƒ­ì— ë“¤ì–´ê°€ì„œ ë§í¬ë¥¼ ë³µì‚¬ í›„ ë¶™ì—¬ë„£ê¸°
          </div>
        </div>
        <div class="flex space-x-8 mt-auto mb-3 justify-center text-sm text-white">
          <button id="confirm" class="border rounded-lg border-blue-500 bg-blue-500 px-4 py-2">
            ì‹ë‹¹ ë“±ë¡
          </button>
          <button id="close-modal" type="button" class="border rounded-lg border-red-500 bg-red-500 px-4 py-2">
            ì·¨ì†Œ
          </button>
      </form>
    </div>
  </div>
  </div>
  </div>
  </div>
</body>

</html>